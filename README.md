# ML Service для обнаружения мошеннических транзакций

Микросервисная система для выявления мошеннических транзакций с использованием очередей сообщений и модели Random Forest.

## Архитектура

Система состоит из следующих микросервисов:

1. **App** - REST API сервис на FastAPI для приема и обработки запросов, а также просмотра результатов.
2. **Bot** - Telegram бот для взаимодействия с пользователями.
3. **ML Worker** - Сервис для выполнения предсказаний по транзакциям, обрабатывающий задания из очереди.
4. **RabbitMQ** - Брокер сообщений для обмена данными между сервисами.
5. **PostgreSQL** - База данных для хранения информации о пользователях, предсказаниях и транзакциях.
6. **Nginx** - Прокси-сервер для маршрутизации HTTP-запросов.

## Схема работы

1. Пользователь делает API запрос через web интерфейс или Telegram бота с данными транзакции
2. Запрос обрабатывается и формируется задание на анализ транзакции
3. Задание попадает в очередь RabbitMQ (`ml_tasks`)
4. Один из ML Worker берет задание и выполняет предсказание с использованием модели Random Forest
5. Результат сохраняется в базе данных и отправляется в очередь результатов (`ml_results`)
6. Пользователь может получить результат через API или получить уведомление через Telegram бота

## Структура проекта

```
.
├── docker-compose.yaml   # Основная конфигурация Docker Compose
├── test_transaction.py   # Скрипт для тестирования API
├── services/
│   ├── app/              # FastAPI приложение с REST API
│   │   ├── Dockerfile
│   │   ├── main.py       # Основной код FastAPI
│   │   ├── requirements.txt
│   │   └── .env
│   ├── bot/              # Telegram бот
│   │   ├── Dockerfile
│   │   ├── bot.py        # Основной код Telegram бота
│   │   ├── requirements.txt
│   │   └── .env
│   ├── ml_worker/        # ML Worker для выполнения предсказаний
│   │   ├── Dockerfile
│   │   ├── main.py       # Код для обработки ML задач
│   │   ├── requirements.txt
│   │   └── .env
│   └── nginx/            # Nginx конфигурация
│       └── nginx.conf
├── models/               # Модели машинного обучения
│   ├── rf_baseline.pkl   # Модель Random Forest
│   └── scaler.pkl        # Скейлер для нормализации данных
```

## Взаимодействие через RabbitMQ

В системе используется две основные очереди:

- **ml_tasks** - очередь для заданий на анализ транзакций
- **ml_results** - очередь для результатов анализа

RabbitMQ настроен в режиме "один издатель - несколько слушателей", что позволяет:
- Публиковать задания из API и Telegram бота в общую очередь
- Выполнять предсказания на нескольких ML Worker параллельно
- Динамически масштабировать количество воркеров в зависимости от нагрузки

## Масштабирование ML Workers

Система поддерживает горизонтальное масштабирование ML Worker:

- По умолчанию запускается 3 воркера
- Для изменения количества воркеров можно использовать параметр `--workers` в скрипте `start.py`
- Или напрямую через Docker Compose: `docker-compose up -d --scale ml-worker=5`

Каждый воркер получает уникальный ID, что позволяет отслеживать, какой именно воркер обработал предсказание.

## Модель машинного обучения

В системе используется модель Random Forest для классификации транзакций на мошеннические и легитимные. Модель имеет следующие характеристики:

- Алгоритм: Random Forest Classifier
- Предобработка: стандартизация числовых признаков
- Файлы модели:
  - `models/rf_baseline.pkl` - обученная модель
  - `models/scaler.pkl` - скейлер для нормализации данных

## Запуск системы

### Быстрый запуск

Для быстрого запуска всей системы достаточно выполнить:

```bash
docker-compose up -d
```

Это запустит все сервисы и создаст 3 экземпляра ML Worker.

### С помощью скрипта start.py

Для удобства управления системой существует скрипт `start.py`, который предоставляет интерактивный режим и командную строку:

```bash
# Запуск интерактивного режима
python start.py

# Запуск всех микросервисов
python start.py --start

# Запуск с указанием количества ML воркеров
python start.py --start --workers 5

# Остановка всех микросервисов
python start.py --stop

# Проверка статуса
python start.py --status

# Просмотр логов
python start.py --logs
```

## Тестирование системы

Вы можете протестировать систему следующими способами:

### Через скрипт test_transaction.py

```bash
python test_transaction.py
```

### Через REST API

1. Откройте Swagger документацию по адресу http://localhost/docs
2. Зарегистрируйтесь или используйте тестового пользователя (логин: test, пароль: test)
3. Получите токен через `/token`
4. Отправьте запрос на анализ транзакции через `/predictions/predict` с JSON данными:
```json
{
  "data": {
    "transaction": {
      "id": "tx123456",
      "amount": 1000.00,
      "hour": 14,
      "day": 3,
      "month": 7,
      "origin_account": "acc123",
      "dest_account": "acc456",
      "old_balance_orig": 5000.00,
      "new_balance_orig": 4000.00,
      "old_balance_dest": 1000.00,
      "new_balance_dest": 2000.00,
      "is_flagged": 0
    }
  }
}
```
5. Проверьте результат через `/predictions/{prediction_id}`

### Через Telegram бота

1. Запустите бота командой `/start`
2. Используйте команду `/predict` для отправки данных транзакции
3. Дождитесь уведомления о готовности результата

## Endpoints

API доступен по адресу http://localhost:80 и предоставляет следующие endpoints:

- `/docs` - Swagger документация API
- `/users` - Регистрация пользователя
- `/token` - Получение токена аутентификации
- `/predictions/predict` - Отправка запроса на анализ транзакции
- `/predictions/{prediction_id}` - Получение результата анализа
- `/predictions` - Получение истории анализов
- `/balance` - Получение баланса пользователя
- `/health` - Проверка работоспособности сервиса

## Мониторинг и управление

### RabbitMQ

Веб-интерфейс RabbitMQ доступен по адресу http://localhost:15672 
(логин: guest, пароль: guest).

Здесь вы можете:
- Отслеживать очереди и их состояние
- Смотреть статистику обработки сообщений
- Проверять количество активных соединений

### Просмотр логов

Для просмотра логов отдельных сервисов:

```bash
docker-compose logs app     # Логи FastAPI приложения
docker-compose logs bot     # Логи Telegram бота
docker-compose logs ml-worker  # Логи ML Worker
docker-compose logs rabbitmq   # Логи RabbitMQ
```